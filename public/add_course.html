<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Новый курс</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/assets/custom.css" type="text/css">
</head>

<body class="addVacancy">
<div class="py-3">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Новый курс&nbsp;<small class="text-muted"></small></h1>
            </div>
        </div>
    </div>
</div>
<div class="py-5">
    <div class="container">
        <div class="form-row">
            <div class="col addFormContainer">
                <form class="mainForm">
                    <div class="form-group">
                        <label class="h3">Название курса</label>
                        <input type="" class="form-control" placeholder="" name="name">
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div class="col form-group">
                                <label>Платформа</label>
                                <input type="text" class="form-control" name="platform">
                            </div>
                            <div class="col form-group">
                                <label>Ссылка на курс</label>
                                <input type="text" class="form-control" name="url">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div class="col form-group">
                                <label>Формат</label>
                                <select class="form-control" name="format">
                                    <option>Вебинар</option>
                                    <option>Видео</option>
                                    <option>Очный</option>
                                    <option>Онлайн</option>
                                    <option>Текстовый</option>
                                    <option>Интерактивный</option>
                                    <option>Вечерний</option>
                                    <option>Выходные</option>
                                    <option>Интенсив</option>
                                </select>
                            </div>
                            <div class="col form-group">
                                <label>Сертификат,&nbsp;диплом</label>
                                <select class="form-control" name="certificate">
                                    <option>Нет</option>
                                    <option>Собственный</option>
                                    <option>Государственного образца</option>
                                    <option>Международный</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Город</label>
                        <input class="form-control" placeholder="" name="city">
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div class="col form-group">
                                <label>Стоимость</label>
                                <input type="number" class="form-control" name="price">
                            </div>
                            <div class="col form-group">
                                <label>Длительность</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="duration">
                                    <div class="input-group-append">
                                        <select class="form-control" name="durationUnits">
                                            <option>минута</option>
                                            <option>ак. час</option>
                                            <option>урок</option>
                                            <option>модуль</option>
                                            <option>час</option>
                                            <option>день</option>
                                            <option>неделя</option>
                                            <option>месяц</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-check py-1">
                        <input type="checkbox" class="form-check-input" value="1" name="hasTeacher">
                        <label class="form-check-label">Обучение с преподавателем</label>
                    </div>
                    <div class="form-check py-1">
                        <input type="checkbox" class="form-check-input" value="1" name="hasPractice">
                        <label class="form-check-label">Есть практика</label>
                    </div>
                    <div class="form-check py-1">
                        <input type="checkbox" class="form-check-input" value="1" name="jobPlacement">
                        <label class="form-check-label">Помощь в трудоустройстве</label>
                    </div>
                    <div class="form-check py-1">
                        <input type="checkbox" class="form-check-input" value="1" name="forKids">
                        <label class="form-check-label">Подходит для детей и школьников</label>
                    </div>

                    <div class="form-group py-3">
                        <div class="form-group">
                            <label class="h3">Описание курса</label>
                            <textarea
                                    placeholder=""
                                    class="form-control"
                                    rows="6" name="description"></textarea>
                        </div>
                    </div>

                    <div class="form-row pt-3">
                        <label class="h3">Получаемые навыки</label>
                        <button class="addSkillButton" data-toggle="modal" data-target="#addSkillModal" type="button">
                            <img src="/assets/images/plus.svg">
                            Добавить получаемые навыки
                        </button>
                    </div>

                    <div class="form-row skillContainer">
                    </div>

                    <div class="form-row pt-3">
                        <label class="h3">Требования</label>
                        <button class="addRequirementButton" data-toggle="modal" data-target="#addRequirementModal" type="button">
                            <img src="/assets/images/plus.svg">
                            Добавить требования
                        </button>
                    </div>

                    <div class="form-row requirementsContainer">
                    </div>

                </form>
            </div>
        </div>
        <div class="form-row mt-3">
            <div class="col">
                <a class="btn btn-primary btn-block btn-lg saveCourse" href="#">Сохранить курс</a>
            </div>
        </div>
        <div class="form-row mt-1">
            <div class="col">
                <div class="alert alert-success saveResult"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addSkillModal" tabindex="-1" role="dialog" aria-labelledby="addSkillModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSkillModalTitle">Добавление навыков</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group skillList">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="button" id="profSkillSubmit" class="btn btn-primary confirmSkillsAddButton" data-dismiss="modal">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addRequirementModal" tabindex="-1" role="dialog" aria-labelledby="addRequirementModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRequirementModalTitle">Добавление требований</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group requirementList">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="button" id="profReqSubmit" class="btn btn-primary confirmRequirementsAddButton" data-dismiss="modal">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

    <script>
        function getSkillLevels() {
            return ['Не владею', 'Основы', 'Уверенный', 'Глубокий'];
        }

        function getSkillsFilter(isRequirement) {
            let skillsData = {};
            let blockSelector = isRequirement ? '.requirementsContainer .skillBlock' : '.skillContainer .skillBlock';

            $(blockSelector).each(function () {
                let skillName = $(this).find('h4').text();
                let skillLevel = parseInt( $(this).find('select').val() ) || 0;

                skillsData[skillName] = skillLevel;
            });

            return skillsData;
        }

        function getSelectedSkillNames(isRequirement) {
            return Object.keys(getSkillsFilter(isRequirement));
        }

        function addSkill(skillId, skillName, skillLevel, isRequirement) {
            let container = isRequirement ? '.requirementsContainer' :'.skillContainer';

            let selectedSkills = getSelectedSkillNames(isRequirement);
            let isSelected = selectedSkills.indexOf(skillName) !== -1;
            let colorClass = "alert-primary";

            if (isSelected) {
                return;
            }

            let skillHTML = "<div class=\"alert " + colorClass + " d-flex justify-content-between skillBlock mr-2\" role=\"alert\" data-name=\""+skillName+"\">\n" +
                "    <div class=\"levelHeaderContainer\">\n" +
                "       <h4 class=\"alert-heading\">"+skillName+"</h4>\n" +
                "       <button type=\"button\" class=\"close align-self-start\" data-dismiss=\"alert\">×</button>\n" +
                "    </div>\n" +
                "    <select class=\"custom-select skillSlider\" name='" + (isRequirement ? 'requirements' : 'skills') + "["+skillId+"]'>\n" +
                getSkillLevels().map(function (skillText, index) {
                    let isSelected = skillLevel === index.toString();
                    return "       <option value="+index+" "+(isSelected?"selected":"")+">"+skillText+"</option>\n";
                }).join("\n") +
                "    </select>\n" +
                "</div>\n";

            $(container).prepend(skillHTML);
        }

        function addSkillsToPopup(professionSkills, isRequirements) {
            let skillsHtml = [];
            let professions = Object.keys(professionSkills);
            let hrefCode = isRequirements ? 'profReq' : 'profSkill';

            skillsHtml.push('<ul class="nav flex-column" id="'+hrefCode+'TOC">');
            professions.forEach(function (profession, index) {
                skillsHtml.push("<li class=\"nav-item\"><a class='nav-link' href='#"+hrefCode+index+"'>"+profession+'</a></li>');
            });
            skillsHtml.push('</ul>');

            professions.forEach(function (profession, index) {
                let allSkills = professionSkills[profession];
                skillsHtml.push("<div class='list-group-item' id='"+hrefCode+index+"'>"+profession+"<a href='#"+hrefCode+"TOC'>&nbsp;&uarr;&nbsp;</a><a href='#"+hrefCode+"Submit'>&nbsp;&darr;&nbsp;</a></div>");

                allSkills.forEach(function (skill, index) {
                    let itemHTML =
                        "<div class=\"list-group-item list-group-item-action\" data-name=\""+skill.name+"\" data-id=\""+skill.id+"\">\n" +
                        "    <div class=\"form-inline skill-form\">\n" +
                        "        <div class=\"form-group col-1\">\n" +
                        "            <div class=\"form-check\">\n" +
                        "                <input class=\"form-check-input\" type=\"checkbox\" value=\"\" id=\"check"+index+"\">\n" +
                        "            </div>\n" +
                        "        </div>\n" +
                        "        <div class=\"form-group col-5\">\n" +
                        "            <label class=\"form-check-label\">\n" +
                        "                "+skill.name+"\n" +
                        "            </label>\n" +
                        "        </div>\n" +
                        "        <div class=\"form-group col-5\">\n" +
                        "        <select class=\"custom-select\">\n" +
                        "           <option selected value=\"0\">Сведения</option>\n" +
                        "           <option selected value=\"1\">Основы</option>\n" +
                        "           <option value=\"2\">Уверенный</option>\n" +
                        "           <option value=\"3\">Глубокий</option>\n" +
                        "        </select>\n" +
                        "        </div>\n" +
                        "    </div>\n" +
                        "</div>";

                    skillsHtml.push(itemHTML);
                }, this);
            }, this);

            if (isRequirements) {
                $('.requirementList').html(skillsHtml.join(''));
            }
            else {
                $('.skillList').html(skillsHtml.join(''));
            }
        }

        $(document).on('click', '.skillList .list-group-item-action, .requirementList .list-group-item-action', function (event) {
            let isCheckboxClicked = event.target.nodeName == 'INPUT';
            let isLevelSelectClicked = event.target.nodeName == 'SELECT' || event.target.nodeName == 'OPTION';
            let isItemActive = $(this).hasClass('active');

            if (isLevelSelectClicked) {
                return;
            }

            let newActiveState = isCheckboxClicked
                ? $(event.target).prop('checked')
                : !isItemActive;

            if (newActiveState) {
                $(this).addClass('active');
            }
            else {
                $(this).removeClass('active');
            }

            if (!isCheckboxClicked) {
                let $input = $(this).find('input');
                $input.prop('checked', newActiveState);
            }
        });


        function loadSkills() {
            let promise = $.Deferred();

            $.ajax({
                url: "/api/skills.php",
                dataType: 'json',
                success: function (result) {
                    promise.resolve(result);
                },
                error: function (result) {
                    if (result && result.status === 200) {
                        promise.resolve(result.responseText);
                    }
                    else {
                        promise.reject(result);
                    }
                }
            });

            return promise;
        }

        function saveCourse() {
            let promise = $.Deferred();
            let courseData = $('.mainForm').serialize();

            $.ajax({
                url: "/api/saveCourse.php",
                data: courseData,
                type: "POST",
                dataType: 'json',
                success: function (result) {
                    promise.resolve(result);
                },
                error: function (result) {
                    if (result && result.status === 200) {
                        promise.resolve(result.responseText);
                    }
                    else {
                        promise.reject(result);
                    }
                }
            });

            return promise;
        }

        $(function () {
            loadSkills()
                .then(function (professonsSkills) {
                    addSkillsToPopup(professonsSkills, false);
                    addSkillsToPopup(professonsSkills, true);
                });

            $(document).on('click', '.confirmSkillsAddButton', function () {
                $('.skillList .active').each(function () {
                    let skillName = $(this).data('name');
                    let skillId = $(this).data('id');
                    let skillLevel = $(this).find('select').val();
                    addSkill(skillId, skillName, skillLevel);
                });
            });

            $(document).on('click', '.confirmRequirementsAddButton', function () {
                $('.requirementList .active').each(function () {
                    let skillName = $(this).data('name');
                    let skillId = $(this).data('id');
                    let skillLevel = $(this).find('select').val();
                    addSkill(skillId, skillName, skillLevel, true);
                });
            });

            $(document).on('click', '.saveCourse', function (event) {
                event.preventDefault();
                $('.saveResult').text('Сохраняю...');

                saveCourse()
                    .then(function (result) {
                        if (result.id) {
                            $('.saveResult')
                                .removeClass('alert-success alert-danger')
                                .addClass('alert-success')
                                .text('ID: '+result.id);
                        }
                        else {
                            $('.saveResult')
                                .removeClass('alert-success alert-danger')
                                .addClass('alert-danger')
                                .text('Ошибка!');
                        }
                    })
                    .catch(function () {
                        $('.saveResult')
                            .removeClass('alert-success alert-danger')
                            .addClass('alert-danger')
                            .text('Ошибка!');
                    });
            });
        });

    </script>
</div>
</body>

</html>